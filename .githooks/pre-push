#!/bin/sh
# Hook to validate branch names before push

# Get current branch name
branch=$(git rev-parse --abbrev-ref HEAD)

# Regex to validate branch name
valid_pattern="^(feat|fix|chore|docs|refactor|test)\/[a-z0-9-]+$"

# Special allowed branches
if [ "$branch" = "main" ] || [ "$branch" = "develop" ] || [ "$branch" = "master" ]; then
    exit 0
fi

# Check format
if ! echo "$branch" | grep -qE "$valid_pattern"; then
    echo "‚ùå Invalid branch name: $branch"
    echo ""
    echo "Required format: type/description-in-kebab-case"
    echo "Valid types: feat, fix, chore, docs, refactor, test"
    echo ""
    echo "Valid examples:"
    echo "  feat/add-user-authentication"
    echo "  fix/memory-leak-issue"
    echo "  chore/update-dependencies"
    echo "  docs/api-documentation"
    echo ""
    echo "To rename your branch:"
    echo "  git branch -m $branch <new-name>"
    echo ""
    exit 1
fi

echo "‚úÖ Valid branch name: $branch"

# Run CI-critical checks before push
echo "üîç Running CI-critical checks..."
if ! make check-ci > /dev/null 2>&1; then
    echo "‚ùå CI checks failed! Run 'make check-ci' to see details."
    echo ""
    echo "To fix common issues:"
    echo "  make format     # Fix formatting"
    echo "  make check-ci   # Check syntax"
    echo ""
    exit 1
fi

echo "‚úÖ CI checks passed!"
exit 0